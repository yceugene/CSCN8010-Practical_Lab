<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html><head></head><body>

















<main>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h1>Practical Lab2: Multivariate Linear Regression, Non-Parametric Models and Cross-Validation<a rel="noopener" class="anchor-link" href="#Practical-Lab2:-Multivariate-Linear-Regression,-Non-Parametric-Models-and-Cross-Validation">&#182;</a></h1>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h2>Part 1<a rel="noopener" class="anchor-link" href="#Part-1">&#182;</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Setup environments</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[244]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Import libraries</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">kagglehub</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">kaggle.api.kaggle_api_extended</span><span class="w"> </span><span class="kn">import</span> <span class="n">KaggleApi</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn</span><span class="w"> </span><span class="kn">import</span> <span class="n">metrics</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_agg</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">seaborn.axisgrid</span><span class="w"> </span><span class="kn">import</span> <span class="n">JointGrid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">IPython.display</span><span class="w"> </span><span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_diabetes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.feature_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">SequentialFeatureSelector</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.tree</span><span class="w"> </span><span class="kn">import</span> <span class="n">plot_tree</span>

<span class="c1"># Setup environments</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span> 
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s2">&quot;whitegrid&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>0.13.2
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Functions defined in this report</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[40]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="k">def</span><span class="w"> </span><span class="nf">MyPlot</span><span class="p">(</span><span class="n">_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">_title</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">_xlabel</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># Create a figure with two subplots side by side</span>
    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>  <span class="c1"># Adjust the figure size to fit both plots</span>

    <span class="c1"># Histogram with KDE</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">_title</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">_xlabel</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">_data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">_data</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Median: </span><span class="si">{</span><span class="n">_data</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="c1"># Boxplot</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">_data</span><span class="p">,</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">vert</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="c1">#, color=&#39;blue&#39;, )</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">_title</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">_xlabel</span><span class="p">)</span>

    <span class="c1"># Improve the layout to prevent overlap and ensure the plot is displayed correctly</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="c1"># Show the plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Example usage:</span>
<span class="c1"># Assuming &#39;labels_y&#39; is your DataFrame or Series containing the data</span>
<span class="c1"># MyPlot(data=labels_y, title=&quot;Disease progression one year after baseline&quot;, xlabel=&quot;Disease progression&quot;)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Framing the Problem<a rel="noopener" class="anchor-link" href="#Framing-the-Problem">&#182;</a></h3><ul>
<li>This report tries to find aout which approach is better for predicting the risk of diabetes progression, that is formed as the disease progression one year after baseline. The following approaches will be selected and compared in this work: Univariate polynomial regression model, Multivariate Polynomial model, Decision Trees and KNN.</li>
<li>All methods will be evaluated using R-squared, MAPE and MAE metrics over the training and testing results.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Getting the Data<a rel="noopener" class="anchor-link" href="#Getting-the-Data">&#182;</a></h3>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Data Source: Downloaded from , <a rel="noopener" href="https://scikit-learn.org/stable/datasets/toy_dataset.html#diabetes-dataset">Diabetes dataset</a>, <a rel="noopener" href="https://scikit-learn.org/stable/modules/generated/sklearn.datasets.load_diabetes.html#sklearn.datasets.load_diabetes">load_diabetes</a></p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>About the dataset:</p>
<ul>
<li>age: age in years</li>
<li>sex: Gender of the patient (But it doesn&#39;t show that which number refers to male and female.)</li>
<li>bmi: body mass index</li>
<li>bp: average blood pressure</li>
<li>s1: tc, total serum cholesterol</li>
<li>s2: ldl, low-density lipoproteins</li>
<li>s3: hdl, high-density lipoproteins</li>
<li>s4: tch, total cholesterol / HDL</li>
<li>s5 ltg, possibly log of serum triglycerides level</li>
<li>s6 glu, blood sugar level</li>
</ul>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Load dataset</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[153]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">diabetes_X</span><span class="p">,</span> <span class="n">labels_y</span> <span class="o">=</span> <span class="n">load_diabetes</span><span class="p">(</span>
    <span class="n">return_X_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">as_frame</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span> <span class="c1"># To get the raw data rather than after doing standardization.</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>EDA<a rel="noopener" class="anchor-link" href="#EDA">&#182;</a></h3><p>Describe and explore our dataset.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[152]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df_merged</span> <span class="o">=</span> <span class="n">diabetes_X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels_y</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shapes: diabetes_X:</span><span class="si">{</span><span class="n">diabetes_X</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, labels_y:</span><span class="si">{</span><span class="n">labels_y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, df_merged:</span><span class="si">{</span><span class="n">df_merged</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># df_merged[&quot;labels_norm&quot;] = (df_merged.labels - df_merged.labels.mean()) / df_merged.labels.std()</span>
<span class="n">df_merged</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Shapes: diabetes_X:(442, 10), labels_y:(442,), df_merged:(442, 11)
</pre>
</div>
</div>
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[152]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>age</th>
<th>sex</th>
<th>bmi</th>
<th>bp</th>
<th>s1</th>
<th>s2</th>
<th>s3</th>
<th>s4</th>
<th>s5</th>
<th>s6</th>
<th>labels</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>59.0</td>
<td>2.0</td>
<td>32.1</td>
<td>101.0</td>
<td>157.0</td>
<td>93.2</td>
<td>38.0</td>
<td>4.0</td>
<td>4.8598</td>
<td>87.0</td>
<td>151.0</td>
</tr>
<tr>
<th>1</th>
<td>48.0</td>
<td>1.0</td>
<td>21.6</td>
<td>87.0</td>
<td>183.0</td>
<td>103.2</td>
<td>70.0</td>
<td>3.0</td>
<td>3.8918</td>
<td>69.0</td>
<td>75.0</td>
</tr>
<tr>
<th>2</th>
<td>72.0</td>
<td>2.0</td>
<td>30.5</td>
<td>93.0</td>
<td>156.0</td>
<td>93.6</td>
<td>41.0</td>
<td>4.0</td>
<td>4.6728</td>
<td>85.0</td>
<td>141.0</td>
</tr>
<tr>
<th>3</th>
<td>24.0</td>
<td>1.0</td>
<td>25.3</td>
<td>84.0</td>
<td>198.0</td>
<td>131.4</td>
<td>40.0</td>
<td>5.0</td>
<td>4.8903</td>
<td>89.0</td>
<td>206.0</td>
</tr>
<tr>
<th>4</th>
<td>50.0</td>
<td>1.0</td>
<td>23.0</td>
<td>101.0</td>
<td>192.0</td>
<td>125.4</td>
<td>52.0</td>
<td>4.0</td>
<td>4.2905</td>
<td>80.0</td>
<td>135.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df_merged</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[7]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>age</th>
<th>sex</th>
<th>bmi</th>
<th>bp</th>
<th>s1</th>
<th>s2</th>
<th>s3</th>
<th>s4</th>
<th>s5</th>
<th>s6</th>
<th>labels</th>
</tr>
</thead>
<tbody>
<tr>
<th>count</th>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
<td>442.000000</td>
</tr>
<tr>
<th>mean</th>
<td>48.518100</td>
<td>1.468326</td>
<td>26.375792</td>
<td>94.647014</td>
<td>189.140271</td>
<td>115.439140</td>
<td>49.788462</td>
<td>4.070249</td>
<td>4.641411</td>
<td>91.260181</td>
<td>152.133484</td>
</tr>
<tr>
<th>std</th>
<td>13.109028</td>
<td>0.499561</td>
<td>4.418122</td>
<td>13.831283</td>
<td>34.608052</td>
<td>30.413081</td>
<td>12.934202</td>
<td>1.290450</td>
<td>0.522391</td>
<td>11.496335</td>
<td>77.093005</td>
</tr>
<tr>
<th>min</th>
<td>19.000000</td>
<td>1.000000</td>
<td>18.000000</td>
<td>62.000000</td>
<td>97.000000</td>
<td>41.600000</td>
<td>22.000000</td>
<td>2.000000</td>
<td>3.258100</td>
<td>58.000000</td>
<td>25.000000</td>
</tr>
<tr>
<th>25%</th>
<td>38.250000</td>
<td>1.000000</td>
<td>23.200000</td>
<td>84.000000</td>
<td>164.250000</td>
<td>96.050000</td>
<td>40.250000</td>
<td>3.000000</td>
<td>4.276700</td>
<td>83.250000</td>
<td>87.000000</td>
</tr>
<tr>
<th>50%</th>
<td>50.000000</td>
<td>1.000000</td>
<td>25.700000</td>
<td>93.000000</td>
<td>186.000000</td>
<td>113.000000</td>
<td>48.000000</td>
<td>4.000000</td>
<td>4.620050</td>
<td>91.000000</td>
<td>140.500000</td>
</tr>
<tr>
<th>75%</th>
<td>59.000000</td>
<td>2.000000</td>
<td>29.275000</td>
<td>105.000000</td>
<td>209.750000</td>
<td>134.500000</td>
<td>57.750000</td>
<td>5.000000</td>
<td>4.997200</td>
<td>98.000000</td>
<td>211.500000</td>
</tr>
<tr>
<th>max</th>
<td>79.000000</td>
<td>2.000000</td>
<td>42.200000</td>
<td>133.000000</td>
<td>301.000000</td>
<td>242.400000</td>
<td>99.000000</td>
<td>9.090000</td>
<td>6.107000</td>
<td>124.000000</td>
<td>346.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Run normalization with <code>Disease progression one year after baseline</code></p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Run normalization with labels &quot;Disease progression one year after baseline&quot;</span>
<span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;labels_norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_merged</span><span class="o">.</span><span class="n">labels</span> <span class="o">-</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">df_merged</span><span class="o">.</span><span class="n">labels_norm</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[15]:</div>
<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult">
<pre>count    4.420000e+02
mean    -1.567374e-16
std      1.000000e+00
min     -1.649092e+00
25%     -8.448689e-01
50%     -1.509019e-01
75%      7.700636e-01
max      2.514710e+00
Name: labels_norm, dtype: float64</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Draw histogram and Whisker plot with <code>Disease progression one year after baseline</code>.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[41]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">MyPlot</span><span class="p">(</span><span class="n">_data</span><span class="o">=</span><span class="n">labels_y</span><span class="p">,</span> 
       <span class="n">_title</span><span class="o">=</span><span class="s2">&quot;Disease progression one year after baseline&quot;</span><span class="p">,</span> 
       <span class="n">_xlabel</span><span class="o">=</span><span class="s2">&quot;Disease progression&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Observation:</p>
<ul>
<li>For all variables in diabeties, mean value is closed to median value.</li>
<li>For the labels, mean (152.133484) is higher than median (140.500000), shows that the dataset might be right-skew distribution.</li>
<li>After normalization, max label value becomes 2.514710 less than 3, so there might be no serious outliers.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Draw histogram for all variables</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Flatten to 1D array for easier iteration</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_merged</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># Histogram with dark blue color and KDE with a contrasting light green color</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;density&#39;</span><span class="p">,</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">})</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Mean: </span><span class="si">{</span><span class="n">df_merged</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Median: </span><span class="si">{</span><span class="n">df_merged</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Remove any unused subplots</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>According to the histogram, most of the variables are distributed in a shape similar to normal distribution, such as s1, s2, s5, s6. Some shows a right skewed distribution, like s3, s4 and the label.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Draw scatter plot for all independent variables</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[148]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df_merged</span>
<span class="n">dependent_var</span> <span class="o">=</span> <span class="s1">&#39;labels&#39;</span>  <span class="c1"># Replace with the name of your dependent variable</span>
<span class="k">if</span> <span class="s2">&quot;labels_norm&quot;</span> <span class="ow">in</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">df_merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;labels_norm&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>  <span class="c1"># Flatten to 1D array for easier iteration</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">dependent_var</span><span class="p">)):</span>  <span class="c1"># Exclude the dependent variable from plotting</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="c1"># sns.scatterplot(data=df, x=col, y=dependent_var, ax=ax, color=&#39;blue&#39;, edgecolor=&#39;white&#39;)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">dependent_var</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">scatter_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;edgecolor&#39;</span><span class="p">:</span><span class="s1">&#39;white&#39;</span><span class="p">},</span> <span class="n">line_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;red&#39;</span><span class="p">})</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Scatter Plot: </span><span class="si">{</span><span class="n">dependent_var</span><span class="si">}</span><span class="s1"> vs </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">dependent_var</span><span class="p">)</span>

<span class="c1"># Remove any unused subplots</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Based on the observation of scatter plot and regplot, it shows that:</p>
<ol>
<li>These variables bmi, bp, s1, s2, ,s4, s5, and s6, shows a positive relationship with the dependent variable, which might be useful for training a regression model for prediction.</li>
<li>However s3 shows a negitive relationship.</li>
<li>There&#39;s no relation between the label and sex.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Corretation matrix</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[151]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Show corretation matrix</span>
<span class="n">correlation_matrix</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
<span class="c1"># print(correlation_matrix)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">correlation_matrix</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;.2f&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">square</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Correlation Matrix Heatmap&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Analysis of Variables Strongly Correlated with labels</p>
<ul>
<li>BMI: The correlation coefficient is 0.59, indicating a strong positive correlation between bmi and labels. This means that as bmi increases, the values of labels also tend to increase.</li>
<li>BP: The correlation coefficient is 0.44, showing a positive correlation with labels. As blood pressure increases, the values of labels also tend to rise.</li>
<li>s3: The correlation coefficient is -0.39, indicating a negative correlation with labels. An increase in s3 is associated with a decrease in the values of labels.</li>
</ul>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Check if there exists NaN in our dataset.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[51]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">any_nan</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Is there any nan? </span><span class="si">{</span><span class="n">any_nan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">total_nan</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total number of NaN in DataFrame: </span><span class="si">{</span><span class="n">total_nan</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Is there any nan? False
Total number of NaN in DataFrame: 0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Data cleaning<br/>
Since, there are no outliers, and no nan values, we decide not to filt any values.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Split into train/validation/test set<a rel="noopener" class="anchor-link" href="#Split-into-train/validation/test-set">&#182;</a></h3><ul>
<li>Based on the requirements, the dataset should be splited to a train (75%), validation set (10%), and test set (15%).</li>
</ul>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[131]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">df_merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df_merged</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>

<span class="c1"># Select 75% for training set</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># Select 10% for validation set and 15% for testing set </span>
<span class="n">X_valid</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">train_size</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Shape of: Train:</span><span class="si">{</span><span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Validation:</span><span class="si">{</span><span class="n">X_valid</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, Test:</span><span class="si">{</span><span class="n">X_test</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Shape of: Train:(331, 10), Validation:(44, 10), Test:(67, 10).
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h2>Part 2.<a rel="noopener" class="anchor-link" href="#Part-2.">&#182;</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Univariate polynomial regression<a rel="noopener" class="anchor-link" href="#Univariate-polynomial-regression">&#182;</a></h3>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Run train and test with polynomial regression model by using <code>BMI featur</code>e versus <code>disease progression one year after baseline</code>, with different degree (0~5).</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[178]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Get bmi values from each set</span>
<span class="n">selected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bmi&quot;</span><span class="p">]</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the evaluation results for each model</span>
<span class="n">pipelines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the models and polynomial featuers</span>

<span class="c1"># Train and test the six models (degree 0~5)</span>
<span class="k">for</span> <span class="n">degree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="c1"># Create a pipeline with poly and model</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">())</span>
    <span class="p">])</span>

    <span class="c1"># Training</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">pipelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>

    <span class="c1"># Number of trainable parameters</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span><span class="c1">#input_features=[&#39;BMI&#39;])</span>
    <span class="n">params_nums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>

    <span class="c1"># Storing results</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;degree&#39;</span><span class="p">:</span> <span class="n">degree</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span><span class="p">,</span>
        <span class="s1">&#39;Num_of_params&#39;</span><span class="p">:</span> <span class="n">params_nums</span>
    <span class="p">})</span>
    
<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R_squared_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>  <span class="c1"># Based on R-squared</span>
<span class="n">best_model_degree</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model-degree is: </span><span class="si">{</span><span class="n">best_model_degree</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Print the best model&#39;s equation</span>
<span class="n">best_pipiline</span> <span class="o">=</span> <span class="n">pipelines</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">coef_</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">intercept_</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coeff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The equation of the best model is: y = </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">equation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>degree</th>
<th>R_squared_train</th>
<th>MAE_train</th>
<th>MAPE_train</th>
<th>R_squared_valid</th>
<th>MAE_valid</th>
<th>MAPE_va</th>
<th>Num_of_params</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0</td>
<td>0.000000</td>
<td>66.201641</td>
<td>62.826669</td>
<td>-0.106957</td>
<td>66.057059</td>
<td>71.263880</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>1</td>
<td>0.349672</td>
<td>52.287739</td>
<td>48.362886</td>
<td>0.331264</td>
<td>47.208472</td>
<td>47.060009</td>
<td>2</td>
</tr>
<tr>
<th>2</th>
<td>2</td>
<td>0.350764</td>
<td>52.207314</td>
<td>48.298534</td>
<td>0.331631</td>
<td>47.213700</td>
<td>47.239667</td>
<td>3</td>
</tr>
<tr>
<th>3</th>
<td>3</td>
<td>0.350774</td>
<td>52.198968</td>
<td>48.280744</td>
<td>0.331638</td>
<td>47.185414</td>
<td>47.222673</td>
<td>4</td>
</tr>
<tr>
<th>4</th>
<td>4</td>
<td>0.353014</td>
<td>52.092653</td>
<td>48.053266</td>
<td>0.340758</td>
<td>46.090118</td>
<td>46.050330</td>
<td>5</td>
</tr>
<tr>
<th>5</th>
<td>5</td>
<td>0.354100</td>
<td>52.059191</td>
<td>48.004022</td>
<td>0.349881</td>
<td>45.462122</td>
<td>45.175276</td>
<td>6</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>The best model-degree is: 5
The equation of the best model is: y = 10409.7546 + -1809.2191*bmi + 123.5731*bmi^2 + -4.1234*bmi^3 + 0.0676*bmi^4 + -0.0004*bmi^5
Testing set evaluation is: R^2: 0.267, MAE: 51.75, MAPE: 43.03%
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[173]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># For a given bmi value 30</span>
<span class="n">bmi_value</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">predicted_value</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;bmi&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">bmi_value</span><span class="p">]}))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicted diabetes progression for BMI </span><span class="si">{</span><span class="n">bmi_value</span><span class="si">}</span><span class="s2"> is: </span><span class="si">{</span><span class="n">predicted_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Predicted diabetes progression for BMI 30 is: 189.70
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Based on the result:<a rel="noopener" class="anchor-link" href="#Based-on-the-result:">&#182;</a></h3><ol>
<li>Model degree-5 has the best R-squared value on both training and validation set, it includes 6 trainable parameters.</li>
<li>The Equation is: $y = 10409.7546 + -1809.2191*bmi + 123.5731*bmi^2 + -4.1234*bmi^3 + 0.0676*bmi^4 + -0.0004*bmi^5$</li>
<li>Testing set evaluation is: R^2: 0.267, MAE: 51.75, MAPE: 43.03%</li>
<li>The number of trainable parameters is equal to <code>degree + 1</code></li>
<li>Predicted diabetes progression for BMI 30 is: 189.70</li>
</ol>
<p>(Note: The equation is displayed by four decimal digit precision, since the degree-5 coeff are 0.004 closed to zero, but important to be shown!)</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Visualize the best predict results with train, validation and test data points.<a rel="noopener" class="anchor-link" href="#Visualize-the-best-predict-results-with-train,-validation-and-test-data-points.">&#182;</a></h3>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[180]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Create a figure</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># Data for each set</span>
<span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="s1">&#39;Training Data&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_X_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">,</span> <span class="s1">&#39;Validation Data&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="n">_X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="s1">&#39;Testing Data&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="c1"># Loop through datasets and axes</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">datasets</span><span class="p">):</span>
    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground-Truth&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Model Fit on </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;BMI&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Disease Progression&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[102]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">df_merged</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child jp-OutputArea-executeResult">
<div class="jp-OutputPrompt jp-OutputArea-prompt">Out[102]:</div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>age</th>
<th>sex</th>
<th>bmi</th>
<th>bp</th>
<th>s1</th>
<th>s2</th>
<th>s3</th>
<th>s4</th>
<th>s5</th>
<th>s6</th>
<th>labels</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>59.0</td>
<td>2.0</td>
<td>32.1</td>
<td>101.0</td>
<td>157.0</td>
<td>93.2</td>
<td>38.0</td>
<td>4.0</td>
<td>4.8598</td>
<td>87.0</td>
<td>151.0</td>
</tr>
<tr>
<th>1</th>
<td>48.0</td>
<td>1.0</td>
<td>21.6</td>
<td>87.0</td>
<td>183.0</td>
<td>103.2</td>
<td>70.0</td>
<td>3.0</td>
<td>3.8918</td>
<td>69.0</td>
<td>75.0</td>
</tr>
<tr>
<th>2</th>
<td>72.0</td>
<td>2.0</td>
<td>30.5</td>
<td>93.0</td>
<td>156.0</td>
<td>93.6</td>
<td>41.0</td>
<td>4.0</td>
<td>4.6728</td>
<td>85.0</td>
<td>141.0</td>
</tr>
<tr>
<th>3</th>
<td>24.0</td>
<td>1.0</td>
<td>25.3</td>
<td>84.0</td>
<td>198.0</td>
<td>131.4</td>
<td>40.0</td>
<td>5.0</td>
<td>4.8903</td>
<td>89.0</td>
<td>206.0</td>
</tr>
<tr>
<th>4</th>
<td>50.0</td>
<td>1.0</td>
<td>23.0</td>
<td>101.0</td>
<td>192.0</td>
<td>125.4</td>
<td>52.0</td>
<td>4.0</td>
<td>4.2905</td>
<td>80.0</td>
<td>135.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Conclusion for part-2<a rel="noopener" class="anchor-link" href="#Conclusion-for-part-2">&#182;</a></h3><p>Unit polynomial funciton is not enough for this regression target no matter how large is the degree, because an unique bmi value can maps to different values in the dataset. Thus we need multivariate polynomial fucntion, which takes features from other important factors such as bp or s5.<br/>
We take bmi 30 as an example shown bellow, the value can maps to 4 different labels, such as 310.0, 246.0, 85.0 and 220.0. But if we limit s5 to 5.3845, theres only 1 dependent value 310.0.</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[114]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="c1"># Print all possible data with bmt=30</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;bmi&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">30</span><span class="p">][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;bmi&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">30</span><span class="p">])</span>

<span class="c1"># Print all possible data with bmt=30 and s5=5.3845</span>
<span class="n">s5_value</span> <span class="o">=</span> <span class="mf">5.3845</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;bmi&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;s5&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">s5_value</span><span class="p">)][</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_merged</span><span class="p">[(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;bmi&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_merged</span><span class="p">[</span><span class="s2">&quot;s5&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">s5_value</span><span class="p">)])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>4
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>age</th>
<th>sex</th>
<th>bmi</th>
<th>bp</th>
<th>s1</th>
<th>s2</th>
<th>s3</th>
<th>s4</th>
<th>s5</th>
<th>s6</th>
<th>labels</th>
</tr>
</thead>
<tbody>
<tr>
<th>9</th>
<td>29.0</td>
<td>1.0</td>
<td>30.0</td>
<td>85.0</td>
<td>180.0</td>
<td>93.4</td>
<td>43.0</td>
<td>4.00</td>
<td>5.3845</td>
<td>88.0</td>
<td>310.0</td>
</tr>
<tr>
<th>234</th>
<td>61.0</td>
<td>1.0</td>
<td>30.0</td>
<td>108.0</td>
<td>194.0</td>
<td>100.0</td>
<td>52.0</td>
<td>3.73</td>
<td>5.3471</td>
<td>105.0</td>
<td>246.0</td>
</tr>
<tr>
<th>295</th>
<td>34.0</td>
<td>2.0</td>
<td>30.0</td>
<td>83.0</td>
<td>185.0</td>
<td>107.2</td>
<td>53.0</td>
<td>3.00</td>
<td>4.8203</td>
<td>92.0</td>
<td>85.0</td>
</tr>
<tr>
<th>440</th>
<td>36.0</td>
<td>1.0</td>
<td>30.0</td>
<td>95.0</td>
<td>201.0</td>
<td>125.2</td>
<td>42.0</td>
<td>4.79</td>
<td>5.1299</td>
<td>85.0</td>
<td>220.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>1
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>age</th>
<th>sex</th>
<th>bmi</th>
<th>bp</th>
<th>s1</th>
<th>s2</th>
<th>s3</th>
<th>s4</th>
<th>s5</th>
<th>s6</th>
<th>labels</th>
</tr>
</thead>
<tbody>
<tr>
<th>9</th>
<td>29.0</td>
<td>1.0</td>
<td>30.0</td>
<td>85.0</td>
<td>180.0</td>
<td>93.4</td>
<td>43.0</td>
<td>4.0</td>
<td>5.3845</td>
<td>88.0</td>
<td>310.0</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h2>Part 3<a rel="noopener" class="anchor-link" href="#Part-3">&#182;</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Multivariate polynomial model<a rel="noopener" class="anchor-link" href="#Multivariate-polynomial-model">&#182;</a></h3>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>1. Learning with all independent variables.<a rel="noopener" class="anchor-link" href="#1.-Learning-with-all-independent-variables.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[182]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="c1"># all columns</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the evaluation results for each model</span>
<span class="n">pipelines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the models and polynomial featuers</span>

<span class="c1"># Train and test the six models (degree 0~5)</span>
<span class="k">for</span> <span class="n">degree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="c1"># Create a pipeline with poly and model</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">())</span>
    <span class="p">])</span>

    <span class="c1"># Training</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">pipelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>

    <span class="c1"># Number of trainable parameters</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span><span class="c1">#input_features=[&#39;BMI&#39;])</span>
    <span class="n">params_nums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>

    <span class="c1"># Storing results</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;degree&#39;</span><span class="p">:</span> <span class="n">degree</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span><span class="p">,</span>
        <span class="s1">&#39;Num_of_params&#39;</span><span class="p">:</span> <span class="n">params_nums</span>
    <span class="p">})</span>
    
<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R_squared_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>  <span class="c1"># Based on R-squared</span>
<span class="n">best_model_degree</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model-degree is: </span><span class="si">{</span><span class="n">best_model_degree</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Print the best model&#39;s equation</span>
<span class="n">best_pipiline</span> <span class="o">=</span> <span class="n">pipelines</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">coef_</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">intercept_</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coeff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The equation of the best model is: y = </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">equation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>degree</th>
<th>R_squared_train</th>
<th>MAE_train</th>
<th>MAPE_train</th>
<th>R_squared_valid</th>
<th>MAE_valid</th>
<th>MAPE_va</th>
<th>Num_of_params</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0</td>
<td>0.000000</td>
<td>6.620164e+01</td>
<td>6.282667e+01</td>
<td>-0.106957</td>
<td>66.057059</td>
<td>71.263880</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>1</td>
<td>0.519034</td>
<td>4.405480e+01</td>
<td>3.937052e+01</td>
<td>0.384874</td>
<td>41.830151</td>
<td>40.952900</td>
<td>11</td>
</tr>
<tr>
<th>2</th>
<td>2</td>
<td>0.469463</td>
<td>4.520924e+01</td>
<td>3.985610e+01</td>
<td>0.220748</td>
<td>47.873989</td>
<td>47.436124</td>
<td>66</td>
</tr>
<tr>
<th>3</th>
<td>3</td>
<td>0.781593</td>
<td>2.937647e+01</td>
<td>2.647344e+01</td>
<td>-47.946755</td>
<td>236.030609</td>
<td>224.441089</td>
<td>286</td>
</tr>
<tr>
<th>4</th>
<td>4</td>
<td>1.000000</td>
<td>2.205532e-09</td>
<td>1.882872e-09</td>
<td>-120.456537</td>
<td>488.306214</td>
<td>459.699880</td>
<td>1001</td>
</tr>
<tr>
<th>5</th>
<td>5</td>
<td>1.000000</td>
<td>1.030401e-09</td>
<td>8.391329e-10</td>
<td>-551.387525</td>
<td>616.456116</td>
<td>492.664234</td>
<td>3003</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>The best model-degree is: 1
The equation of the best model is: y = -317.5287 + 0.1735*age + -23.0670*sex + 5.7336*bmi + 1.3137*bp + -1.2638*s1 + 0.7958*s2 + 0.4306*s3 + 9.9446*s4 + 63.4271*s5 + 0.1090*s6
Testing set evaluation is: R^2: 0.524, MAE: 41.36, MAPE: 34.92%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ol>
<li>When using all variables, the best model-degree is 1, acheives R^2 score 0.524 in testing set, which improves 96% of performance comparing with univariate polynomial regression.</li>
<li>While increasing the degree over 1, the overfitting proglem becomes serious, thus the best degree is degree-1.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>2. Learning with a few independent variables: [&#39;bmi&#39;, &#39;s5&#39;, &#39;bp&#39;].<a rel="noopener" class="anchor-link" href="#2.-Learning-with-a-few-independent-variables:-%5B&#39;bmi&#39;,-&#39;s5&#39;,-&#39;bp&#39;%5D.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[189]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bmi&#39;</span><span class="p">,</span> <span class="s1">&#39;s5&#39;</span><span class="p">,</span> <span class="s1">&#39;bp&#39;</span><span class="p">]</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the evaluation results for each model</span>
<span class="n">pipelines</span> <span class="o">=</span> <span class="p">[]</span> <span class="c1"># Store the models and polynomial featuers</span>

<span class="c1"># Train and test the six models (degree 0~5)</span>
<span class="k">for</span> <span class="n">degree</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="c1"># Create a pipeline with poly and model</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">([</span>
        <span class="p">(</span><span class="s1">&#39;poly&#39;</span><span class="p">,</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;model&#39;</span><span class="p">,</span> <span class="n">LinearRegression</span><span class="p">())</span>
    <span class="p">])</span>

    <span class="c1"># Training</span>
    <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">pipelines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pipeline</span><span class="p">)</span>

    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>

    <span class="c1"># Number of trainable parameters</span>
    <span class="n">feature_names</span> <span class="o">=</span> <span class="n">pipeline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span><span class="c1">#input_features=[&#39;BMI&#39;])</span>
    <span class="n">params_nums</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>

    <span class="c1"># Storing results</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;degree&#39;</span><span class="p">:</span> <span class="n">degree</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span><span class="p">,</span>
        <span class="s1">&#39;Num_of_params&#39;</span><span class="p">:</span> <span class="n">params_nums</span>
    <span class="p">})</span>
    
<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R_squared_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>  <span class="c1"># Based on R-squared</span>
<span class="n">best_model_degree</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model-degree is: </span><span class="si">{</span><span class="n">best_model_degree</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Print the best model&#39;s equation</span>
<span class="n">best_pipiline</span> <span class="o">=</span> <span class="n">pipelines</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span>
<span class="n">coefficients</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">coef_</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">intercept_</span>
<span class="n">feature_names</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<span class="n">equation</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coeff</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">coeff</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">)</span> <span class="k">if</span> <span class="n">coeff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The equation of the best model is: y = </span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="n">equation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_pipiline</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output">
<div>

<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>degree</th>
<th>R_squared_train</th>
<th>MAE_train</th>
<th>MAPE_train</th>
<th>R_squared_valid</th>
<th>MAE_valid</th>
<th>MAPE_va</th>
<th>Num_of_params</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>0</td>
<td>0.000000</td>
<td>66.201641</td>
<td>62.826669</td>
<td>-0.106957</td>
<td>66.057059</td>
<td>71.263880</td>
<td>1</td>
</tr>
<tr>
<th>1</th>
<td>1</td>
<td>0.468843</td>
<td>47.163228</td>
<td>42.256639</td>
<td>0.437486</td>
<td>40.858872</td>
<td>40.105858</td>
<td>4</td>
</tr>
<tr>
<th>2</th>
<td>2</td>
<td>0.483629</td>
<td>46.394318</td>
<td>41.109468</td>
<td>0.461941</td>
<td>39.801976</td>
<td>38.763415</td>
<td>10</td>
</tr>
<tr>
<th>3</th>
<td>3</td>
<td>0.498852</td>
<td>45.488982</td>
<td>40.076802</td>
<td>0.503707</td>
<td>37.443323</td>
<td>37.385180</td>
<td>20</td>
</tr>
<tr>
<th>4</th>
<td>4</td>
<td>0.510780</td>
<td>44.773943</td>
<td>39.309116</td>
<td>0.464139</td>
<td>39.690153</td>
<td>39.511314</td>
<td>35</td>
</tr>
<tr>
<th>5</th>
<td>5</td>
<td>0.551657</td>
<td>41.980525</td>
<td>36.699669</td>
<td>0.256234</td>
<td>48.100496</td>
<td>48.018185</td>
<td>56</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>The best model-degree is: 3
The equation of the best model is: y = 3043.8828 + -120.7203*bmi + -1433.2885*s5 + 5.8281*bp + 0.2169*bmi^2 + 28.6855*bmi s5 + 0.9812*bmi bp + 237.0171*s5^2 + 0.0355*s5 bp + -0.2113*bp^2 + 0.0319*bmi^3 + -0.5231*bmi^2 s5 + -0.0025*bmi^2 bp + 1.2693*bmi s5^2 + -0.1363*bmi s5 bp + -0.0006*bmi bp^2 + -21.7869*s5^3 + 0.3499*s5^2 bp + 0.0043*s5 bp^2 + 0.0007*bp^3
Testing set evaluation is: R^2: 0.534, MAE: 42.57, MAPE: 36.24%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ol>
<li>When using three variables <code>[&#39;bmi&#39;, &#39;s5&#39;, &#39;bp&#39;]</code>, the best model-degree is 3, acheives R^2 score 0.534 in testing set, which improves 100% of performance comparing with univariate polynomial regression.</li>
<li>While increasing the degree over 3, the overfitting proglem becomes serious, thus the best degree is degree-3.</li>
<li>The overfitting problem is better than using all variables, this is because our dataset is not big enough to train from a large dimension of features. And when selecting featue, it&#39;s better to choose those with higher correlation to the label value.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Based on the result:</p>
<ol>
<li>Model degree-1 has the best R-squared value on validation set, it includes 6 trainable parameters.</li>
<li>The Equation is: $y = -317.53 + 0.17*age + -23.07*sex + 5.73*bmi + 1.31*bp + -1.26*s1 + 0.80*s2 + 0.43*s3 + 9.94*s4 + 63.43*s5 + 0.11*s6$</li>
<li>It shows that increasing the degree doesn&#39;t always improves the r-squared value in this multivariate model.</li>
<li>This may caused by too much dimension but only a little of data, the data are not enough for model too learn.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Decision trees<a rel="noopener" class="anchor-link" href="#Decision-trees">&#182;</a></h3>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>1. Learning with all independent variables.<a rel="noopener" class="anchor-link" href="#1.-Learning-with-all-independent-variables.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[&#160;]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="c1"># all columns</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">depths</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>

    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R_squared_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_model_depth</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model-depth is: </span><span class="si">{</span><span class="n">best_model_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot the best tree</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">_X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best decision tree with max_depth=</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>   depth  R_squared_train  MAE_train  MAPE_train  R_squared_valid  MAE_valid  \
0      2         0.438054  47.996013   42.480887         0.308988  45.801381   
1      3         0.509503  44.259855   38.866592         0.198306  48.126248   
2      4         0.582718  39.815745   35.304051         0.135616  49.959975   
3      5         0.686693  33.527028   29.973625         0.093919  49.645483   
4      6         0.768015  27.090226   24.903839         0.041672  53.123174   
5      7         0.835427  21.593843   19.701590        -0.267060  60.970943   
6      8         0.887485  16.170979   15.208071        -0.271404  58.410320   
7      9         0.930804  10.942079   10.839348        -0.327677  60.408333   

     MAPE_va  
0  47.609065  
1  47.672897  
2  48.899421  
3  48.161981  
4  50.370046  
5  56.358390  
6  56.110883  
7  56.152932  
The best model-depth is: 2
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Testing set evaluation is: R^2: 0.362, MAE: 48.34, MAPE: 41.86%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Observation:</p>
<ol>
<li>The model become overfiting when depth over than 3.</li>
<li>Since, the dataset is not big enough, 10 features might be too much.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>2. Learning with a few independent variables.<a rel="noopener" class="anchor-link" href="#2.-Learning-with-a-few-independent-variables.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[247]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bmi&#39;</span><span class="p">,</span> <span class="s1">&#39;s5&#39;</span><span class="p">]</span> <span class="c1">#, &#39;bp&#39;]</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">depths</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">depth</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>

    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>

    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R_squared_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R_squared_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_model_depth</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;depth&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model-depth is: </span><span class="si">{</span><span class="n">best_model_depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Plot the best tree</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">plot_tree</span><span class="p">(</span><span class="n">best_model</span><span class="p">,</span> <span class="n">filled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">feature_names</span><span class="o">=</span><span class="n">_X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rounded</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Best decision tree with max_depth=</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>   depth  R_squared_train  MAE_train  MAPE_train  R_squared_valid  MAE_valid  \
0      2         0.438054  47.996013   42.480887         0.308988  45.801381   
1      3         0.499399  44.772746   39.182601         0.335797  43.753465   
2      4         0.553228  41.567909   36.275771         0.369672  41.652870   
3      5         0.615865  37.457356   32.232664         0.373934  43.342610   
4      6         0.678024  33.049936   28.104516         0.289325  47.699200   
5      7         0.735824  27.194263   22.898809         0.030972  53.874783   
6      8         0.785651  23.016085   19.268672         0.005196  54.486605   
7      9         0.855797  17.123986   14.350085        -0.000734  55.219354   

     MAPE_va  
0  47.609065  
1  43.883192  
2  42.582130  
3  44.258703  
4  47.641130  
5  53.927270  
6  51.920000  
7  51.904502  
The best model-depth is: 5
</pre>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedImage jp-OutputArea-output">
<img alt="No description has been provided for this image" src="javascript://"/>
</div>
</div>
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>Testing set evaluation is: R^2: 0.449, MAE: 46.21, MAPE: 39.72%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>Observation:</p>
<ol>
<li>The model become overfiting when depth over than 6.</li>
<li>Rather then previous test, this time we only train model with 1 feature, the bmi, this makes model afforable to be trained and test with a deeper tree.</li>
<li>The testing set evaluation is 0.449, improves 24% compares to the previous test.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>kNNs<a rel="noopener" class="anchor-link" href="#kNNs">&#182;</a></h3>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>1. Learning with all independent variables.<a rel="noopener" class="anchor-link" href="#1.-Learning-with-all-independent-variables.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[217]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span> <span class="c1"># all columns</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">train_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;k_value&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s1">&#39;R^2_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R^2_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R^2_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;k_value&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model is KNN with k = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>    k_value  R^2_train  MAE_train  MAPE_train  R^2_valid  MAE_valid    MAPE_va
0         1   1.000000   0.000000    0.000000  -0.614447  72.590909  66.589251
1         2   0.682213  35.037764   29.052319  -0.497869  68.693182  65.112235
2         3   0.549618  41.957704   36.084057  -0.099842  58.212121  56.323103
3         4   0.490014  44.895770   38.309235   0.021432  55.857955  52.678730
4         5   0.473082  45.790332   39.181443  -0.000485  55.300000  53.547680
5         6   0.462575  46.360524   40.036992   0.129020  50.261364  49.162529
6         7   0.436645  47.731549   41.197469   0.133626  50.327922  48.455028
7         8   0.421184  48.473565   41.991941   0.235458  48.039773  47.113019
8         9   0.430554  48.339040   41.984774   0.235618  48.621212  48.031569
9        10   0.408854  48.936858   42.573951   0.228006  49.509091  48.963058
10       11   0.410259  48.933260   43.187938   0.235641  49.495868  48.479487
11       12   0.396828  49.421450   43.654367   0.244222  49.912879  48.925475
12       13   0.382430  49.758076   43.697259   0.222453  50.604895  50.055371
13       14   0.384175  49.745792   43.635082   0.223349  50.818182  50.059844
14       15   0.371751  50.341994   43.955509   0.236007  50.472727  50.103957
15       16   0.367421  50.652002   44.104230   0.246213  50.052557  49.840951
16       17   0.349525  51.475564   44.945889   0.257774  49.700535  49.672272
17       18   0.347529  51.594327   44.906339   0.250292  49.880051  50.098896
18       19   0.339280  52.039593   45.218040   0.240822  50.183014  50.145749
The best model is KNN with k = 17
Testing set evaluation is: R^2: 0.311, MAE: 53.23, MAPE: 45.40%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>When running KNN regression using all features, <code>k=17</code> gives the best model, the R-square of testing set is 0.311.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>2. Learn from the four features with highest correlation to the label<a rel="noopener" class="anchor-link" href="#2.-Learn-from-the-four-features-with-highest-correlation-to-the-label">&#182;</a></h4><p>According the the correlation map, we select [&#39;bmi&#39;, &#39;bp&#39;, &#39;s5&#39;, &#39;s4&#39;] for KNN</p>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[239]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bmi&#39;</span><span class="p">,</span> <span class="s1">&#39;bp&#39;</span><span class="p">,</span> <span class="s1">&#39;s5&#39;</span><span class="p">,</span> <span class="s1">&#39;s4&#39;</span><span class="p">]</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">train_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;k_value&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s1">&#39;R^2_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R^2_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R^2_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;k_value&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model is KNN with k = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>    k_value  R^2_train  MAE_train  MAPE_train  R^2_valid  MAE_valid    MAPE_va
0         1   1.000000   0.000000    0.000000  -0.459144  67.386364  64.012816
1         2   0.705941  33.522659   28.770826  -0.124821  56.647727  55.915938
2         3   0.607541  39.251762   34.212997   0.115394  51.590909  51.775566
3         4   0.546447  42.688822   37.244710   0.271203  47.414773  48.775262
4         5   0.503415  44.441088   39.256395   0.294162  47.663636  47.287852
5         6   0.484456  46.123867   41.266018   0.303275  47.500000  46.436785
6         7   0.460696  47.169616   42.211652   0.293764  46.668831  46.246789
7         8   0.442604  47.571752   42.874161   0.320129  45.267045  44.338631
8         9   0.447269  47.080228   42.772346   0.294120  46.199495  45.747737
9        10   0.444794  47.442296   43.216348   0.245966  48.018182  47.797140
10       11   0.443353  47.846471   43.395749   0.265515  46.847107  47.057083
11       12   0.438556  47.993454   43.543387   0.281726  46.958333  47.498343
12       13   0.427620  48.362305   43.816171   0.297431  46.167832  47.381847
13       14   0.426569  48.477126   44.083723   0.272568  46.905844  48.623375
14       15   0.429785  48.435650   43.819223   0.284018  47.201515  48.923062
15       16   0.424197  48.581949   44.023391   0.301358  46.142045  47.909563
16       17   0.419214  48.720633   44.238230   0.304976  45.807487  47.323301
17       18   0.409901  49.000671   44.290583   0.335733  45.356061  46.446937
18       19   0.406936  49.359040   44.556521   0.337634  44.934211  46.309677
The best model is KNN with k = 19
Testing set evaluation is: R^2: 0.376, MAE: 46.94, MAPE: 40.87%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>This way the performance are better than using all features.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>3. Learning with one independent variables, the <code>bmi</code> which has the highest correlation to the label.<a rel="noopener" class="anchor-link" href="#3.-Learning-with-one-independent-variables,-the-bmi-which-has-the-highest-correlation-to-the-label.">&#182;</a></h4>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[226]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;bmi&#39;</span><span class="p">]</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">train_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;k_value&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s1">&#39;R^2_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R^2_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R^2_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;k_value&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model is KNN with k = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>    k_value  R^2_train  MAE_train  MAPE_train  R^2_valid  MAE_valid    MAPE_va
0         1   0.225104  41.755287   40.685731   0.025220  55.000000  51.807652
1         2   0.487749  44.173716   40.525708   0.192526  50.090909  48.860767
2         3   0.509615  44.020141   40.082418   0.299682  45.833333  45.983291
3         4   0.508695  45.454683   40.876322   0.338695  42.198864  42.467997
4         5   0.488932  46.387915   40.967958   0.340305  43.209091  42.871488
5         6   0.471654  47.307150   42.265283   0.376337  41.261364  41.816554
6         7   0.448223  48.466120   43.135204   0.333405  43.295455  44.005419
7         8   0.437899  48.669562   44.105074   0.301183  44.744318  45.296888
8         9   0.440152  48.591809   43.606990   0.285492  45.611111  45.981946
9        10   0.418258  49.159215   44.080130   0.327695  45.015909  45.772129
10       11   0.418427  49.251305   44.274219   0.300225  46.801653  47.453264
11       12   0.412810  49.344159   44.099573   0.320717  45.386364  45.686247
12       13   0.411069  49.342087   44.485383   0.321197  45.486014  46.519063
13       14   0.410911  49.312041   44.302013   0.333775  45.082792  45.817817
14       15   0.401994  49.540383   44.472874   0.338786  45.316667  46.340148
15       16   0.398383  49.592334   44.536213   0.336642  45.723011  46.889187
16       17   0.394887  49.922161   44.792768   0.326488  46.205882  47.385372
17       18   0.391212  50.150722   45.059634   0.330886  46.075758  46.989360
18       19   0.394411  50.034982   44.890458   0.339654  45.441388  46.651438
The best model is KNN with k = 6
Testing set evaluation is: R^2: 0.164, MAE: 54.94, MAPE: 45.43%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>When running KNN regression with only <code>bmi</code> feature, <code>k = 6</code> gives the best result, but the testing set evaluation is still bad, the R-square is 0.164 on the testing set. This means that only one feature is not enough to predict the label by KNN.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h4>4. How do we find the best feature-set for KNN?<a rel="noopener" class="anchor-link" href="#4.-How-do-we-find-the-best-feature-set-for-KNN?">&#182;</a></h4>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h5>4.1 Pick up the 4 greatest features, by <code>forwarding from empty set</code>.<a rel="noopener" class="anchor-link" href="#4.1-Pick-up-the-4-greatest-features,-by-forwarding-from-empty-set.">&#182;</a></h5>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[240]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># Assume k = 5</span>

<span class="c1"># Create feature selector</span>
<span class="n">sfs</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">sfs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Get selected features</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sfs</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selected_features:</span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>selected_features:Index([&#39;sex&#39;, &#39;bmi&#39;, &#39;s4&#39;, &#39;s5&#39;], dtype=&#39;object&#39;)
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[241]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="n">selected_features</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">train_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;k_value&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s1">&#39;R^2_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R^2_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R^2_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;k_value&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model is KNN with k = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>    k_value  R^2_train  MAE_train  MAPE_train  R^2_valid  MAE_valid    MAPE_va
0         1   0.991117   0.667674    0.805639   0.038932  51.500000  48.514771
1         2   0.731987  32.276435   27.115380   0.174785  50.625000  50.922153
2         3   0.628458  38.017120   32.293466   0.265738  46.659091  50.523714
3         4   0.569625  41.419940   35.677432   0.352059  45.659091  48.501180
4         5   0.550369  42.377039   36.463289   0.392310  43.409091  45.998399
5         6   0.534662  43.291541   37.101903   0.392595  43.087121  45.911725
6         7   0.519527  44.273198   37.984107   0.388434  42.746753  46.119928
7         8   0.512478  44.362538   38.000527   0.391169  42.997159  45.669529
8         9   0.506677  44.708627   38.600767   0.401482  43.136364  45.290298
9        10   0.500380  45.203021   39.185317   0.426790  41.659091  43.543044
10       11   0.492929  45.540236   39.380747   0.435893  41.051653  43.060928
11       12   0.488480  45.626133   39.450799   0.457546  40.431818  42.714277
12       13   0.469530  46.753428   40.534720   0.444165  40.870629  43.220072
13       14   0.466441  46.935261   40.558509   0.425515  41.149351  43.477204
14       15   0.460811  47.107150   40.628016   0.406947  42.068182  44.556430
15       16   0.459039  47.376888   40.860097   0.421595  41.183239  43.872279
16       17   0.451091  47.768082   41.145926   0.423700  41.573529  44.102572
17       18   0.448051  47.901477   41.293168   0.411627  42.119949  44.989705
18       19   0.444984  47.996820   41.455802   0.421246  41.192584  44.044102
The best model is KNN with k = 12
Testing set evaluation is: R^2: 0.426, MAE: 44.24, MAPE: 37.74%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>The best model is KNN with k=12, the R-square of testing set impoves to 0.426. The result is better than just using four highest correlation features [&#39;bmi&#39;, &#39;bp&#39;, &#39;s5&#39;, &#39;s4&#39;] which has a R-suared value of 0.376.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h5>5.2 Pick up the 4 greatest features, by <code>backwarding from full set</code>.<a rel="noopener" class="anchor-link" href="#5.2-Pick-up-the-4-greatest-features,-by-backwarding-from-full-set.">&#182;</a></h5>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[236]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># Assume k = 5</span>

<span class="c1"># Create feature selector</span>
<span class="n">sfs</span> <span class="o">=</span> <span class="n">SequentialFeatureSelector</span><span class="p">(</span><span class="n">knn</span><span class="p">,</span> <span class="n">n_features_to_select</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;backward&#39;</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="s1">&#39;r2&#39;</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">sfs</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>

<span class="c1"># Get selected features</span>
<span class="n">selected_features</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sfs</span><span class="o">.</span><span class="n">get_support</span><span class="p">()]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;selected_features:</span><span class="si">{</span><span class="n">selected_features</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>selected_features:Index([&#39;age&#39;, &#39;bmi&#39;, &#39;bp&#39;, &#39;s6&#39;], dtype=&#39;object&#39;)
</pre>
</div>
</div>
</div>
</div>
</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&#160;[237]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor">
<div class="cm-editor cm-s-jupyter">
<div class="highlight hl-ipython3"><pre><span></span><span class="n">selected_cols</span> <span class="o">=</span> <span class="n">selected_features</span>
<span class="n">_X_train</span> <span class="o">=</span> <span class="n">X_train</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_valid</span> <span class="o">=</span> <span class="n">X_valid</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>
<span class="n">_X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="n">selected_cols</span><span class="p">]</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">models</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
    <span class="c1"># Create Model</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>

    <span class="c1"># Training</span>
    <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">_X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
    <span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on training set</span>
    <span class="n">y_train_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_train</span><span class="p">)</span>
    <span class="n">mae_tr</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">mape_tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_train</span> <span class="o">-</span> <span class="n">y_train_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_train</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_tr</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    
    <span class="c1"># Evaluate on validation set</span>
    <span class="n">y_valid_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_valid</span><span class="p">)</span>
    <span class="n">mae_va</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">mape_va</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_valid</span> <span class="o">-</span> <span class="n">y_valid_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_valid</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="n">r_squared_va</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">train_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    <span class="n">train_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_train</span><span class="p">,</span> <span class="n">y_train_pred</span><span class="p">)</span>
    <span class="n">valid_r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_valid_pred</span><span class="p">)</span>
    
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;k_value&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s1">&#39;R^2_train&#39;</span><span class="p">:</span> <span class="n">r_squared_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAE_train&#39;</span><span class="p">:</span> <span class="n">mae_tr</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_train&#39;</span><span class="p">:</span> <span class="n">mape_tr</span><span class="p">,</span>
        <span class="s1">&#39;R^2_valid&#39;</span><span class="p">:</span> <span class="n">r_squared_va</span><span class="p">,</span>
        <span class="s1">&#39;MAE_valid&#39;</span><span class="p">:</span> <span class="n">mae_va</span><span class="p">,</span>
        <span class="s1">&#39;MAPE_va&#39;</span><span class="p">:</span> <span class="n">mape_va</span>
    <span class="p">})</span>

<span class="c1"># Display the result table</span>
<span class="n">results_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results_df</span><span class="p">)</span>

<span class="c1"># Choose the best model</span>
<span class="n">best_model_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;R^2_valid&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
<span class="n">best_k</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">][</span><span class="s1">&#39;k_value&#39;</span><span class="p">]</span>
<span class="n">best_model</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="n">best_model_index</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The best model is KNN with k = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Evaluate the model with testing data</span>
<span class="n">y_test_pred</span> <span class="o">=</span> <span class="n">best_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">_X_test</span><span class="p">)</span>
<span class="n">test_mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="n">test_mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_test</span> <span class="o">-</span> <span class="n">y_test_pred</span><span class="p">)</span> <span class="o">/</span> <span class="n">y_test</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">test_r_squared</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_test_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Testing set evaluation is: R^2: </span><span class="si">{</span><span class="n">test_r_squared</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">, MAE: </span><span class="si">{</span><span class="n">test_mae</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, MAPE: </span><span class="si">{</span><span class="n">test_mape</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="jp-Cell-outputWrapper">
<div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
</div>
<div class="jp-OutputArea jp-Cell-outputArea">
<div class="jp-OutputArea-child">
<div class="jp-OutputPrompt jp-OutputArea-prompt"></div>
<div class="jp-RenderedText jp-OutputArea-output">
<pre>    k_value  R^2_train  MAE_train  MAPE_train  R^2_valid  MAE_valid    MAPE_va
0         1   1.000000   0.000000    0.000000  -0.293706  62.636364  61.543935
1         2   0.703951  34.324773   30.630207   0.058621  53.250000  53.819787
2         3   0.616340  37.981873   33.323852   0.099065  52.969697  51.351765
3         4   0.589329  40.090634   36.100583   0.202942  49.335227  45.303916
4         5   0.535610  42.465257   37.908499   0.260597  48.809091  45.759265
5         6   0.512921  43.804129   39.347722   0.282187  49.348485  47.135469
6         7   0.491120  45.143289   41.153508   0.290168  48.032468  46.113886
7         8   0.457700  47.136329   42.608118   0.341594  48.017045  46.221675
8         9   0.445135  47.734475   43.145079   0.326600  48.007576  46.870012
9        10   0.433767  48.354079   43.887118   0.315233  47.979545  46.885630
10       11   0.414847  49.413897   44.863430   0.341929  46.252066  45.619660
11       12   0.403182  49.939829   45.266320   0.329780  46.312500  45.788132
12       13   0.402792  49.985359   45.465428   0.332327  46.694056  46.986317
13       14   0.400370  50.247950   45.684416   0.310267  47.396104  47.464998
14       15   0.397486  50.222356   45.922432   0.313723  47.281818  47.984155
15       16   0.394976  50.406344   45.841242   0.335701  46.286932  46.391170
16       17   0.392701  50.540963   45.935079   0.334124  46.149733  46.268238
17       18   0.387475  51.006210   46.096249   0.329182  46.340909  46.427698
18       19   0.375493  51.530450   46.621074   0.331036  46.437799  46.417594
The best model is KNN with k = 11
Testing set evaluation is: R^2: 0.228, MAE: 52.94, MAPE: 45.65%
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<p>The best model is KNN with k=11, the R-square of testing set is 0.228.</p>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h3>Conclusion for Part-3<a rel="noopener" class="anchor-link" href="#Conclusion-for-Part-3">&#182;</a></h3><ol>
<li>For polynomial model, we have tried choosing all features or just a few features like (bmi, s5, bp), and we found using less features might have better performance and decrease the possible of overfitting.</li>
<li>For decision tree, the phenomenan is similar, dopping some features is better than choosing all the features.</li>
<li>For KNN, fewer features are also greater than using all features. But we met a problem of how to select the features? Can we just pick the 4 features which has higher correlation with the label? Finally, we found that we can add a preprocessing step as well as forwardingly select features with SequentialFeatureSelector(), this can help us choose the best features for KNN.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h2>Summary<a rel="noopener" class="anchor-link" href="#Summary">&#182;</a></h2>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<ol>
<li>Multivariate polynomial model is the best way to predict the risk of diabetes progression in this dataset.</li>
<li>One feature is not enough for model to learn patterns and predict the labels. We need multivariate for all types of approach, like polynomial regression, decision tree and kNN.</li>
<li>Because our dataset is not large enough, it will be difficult to train the model using all features. Thus, in part3 we should only pick a few features for training and testing.</li>
<li>The overfitting problem can occurs when increasing the degree of a polynolial model or the depth of a decision tree.</li>
<li>The perfact way of selecting best feature-set for model is not like only choose the features which are highly correlated to the labels, we can select them by doing cross-validation test with our training data, and choose the best set.</li>
</ol>
</div>
</div>
</div>
</div>
<div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
<div class="jp-Cell-inputWrapper">
<div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
</div>
<div class="jp-InputArea jp-Cell-inputArea"><div class="jp-InputPrompt jp-InputArea-prompt">
</div><div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput">
<h2>Questions (or Todo list)<a rel="noopener" class="anchor-link" href="#Questions-(or-Todo-list)">&#182;</a></h2><ol>
<li>What&#39;s the perfect way of selecting the greatest feature-set? Can we consider it from the correlation heat map?</li>
<li>What does the gender maps to the value in sex column? We haven&#39;nt find the description from the dataset.</li>
<li>Is there anyother data that can be filtered out to improve the model? (Except outliers)</li>
</ol>
</div>
</div>
</div>
</div>
</main>


<script type="module" src="https://s.brightspace.com/lib/bsi/2025.3.233/unbundled/mathjax.js"></script><script type="text/javascript">document.addEventListener('DOMContentLoaded', function() {
						if (document.querySelector('math') || /\$\$|\\\(|\\\[|\\begin{|\\ref{|\\eqref{/.test(document.body.innerHTML)) {
							document.querySelectorAll('mspace[linebreak="newline"]').forEach(elm => {
								elm.setAttribute('style', 'display: block; height: 0.5rem;');
							});

							window.D2L.MathJax.loadMathJax({
								outputScale: 1.5,
								renderLatex: true,
								enableMML3Support: false
							});
						}
					});</script><script type="module" src="https://s.brightspace.com/lib/bsi/2025.3.233/unbundled/prism.js"></script><script type="text/javascript">document.addEventListener('DOMContentLoaded', function() {
					document.querySelectorAll('.d2l-code').forEach(code => {
						window.D2L.Prism.formatCodeElement(code);
					});
				});</script><script type="module" src="https://s.brightspace.com/lib/bsi/2025.3.233/unbundled/embeds.js"></script><script type="text/javascript">document.addEventListener('DOMContentLoaded', function() {
					window.D2L.EmbedRenderer.renderEmbeds(document.body);
				});</script></body></html>